// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
  moduleFormat    = "cjs"
}

datasource db {
  provider = "postgresql"
}


enum ContentType {
  TEXT
  VOICE
}

enum PostType {
  SILVER
  GOLD
  URGENT
}


model User {
  id             String        @id @default(uuid()) @db.Uuid
  anonymousId    String        @unique @map("anonymous_id") // The device hash
  
  subscriptionId String?       @db.Uuid @map("subscription_id")
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id])
  
  posts          Post[]
  responses      Response[]
  pushTokens     PushToken[]
  purchases      Purchase[]

  createdAt      DateTime      @default(now()) @map("created_at")
  lastActiveAt   DateTime?     @map("last_active_at")

  @@map("users")
}

model Post {
  id           String      @id @default(uuid()) @db.Uuid
  userId       String      @db.Uuid @map("user_id")
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  categoryId   String      @db.Uuid @map("category_id")
  category     Category    @relation(fields: [categoryId], references: [id])
  
  contentType  ContentType @map("content_type") 
  textContent  String?     @map("text_content") @db.Text
  voiceUrl     String?     @map("voice_url") @db.Text
  
  expiresAt    DateTime    @map("expires_at")
  isDeleted    Boolean     @default(false) @map("is_deleted")
  createdAt    DateTime    @default(now()) @map("created_at")
 
  isResponseDefaultHidden Boolean     @default(false) @map("is_response_default_hidden")
  PostType     PostType   @default(SILVER) @map("post_type")
  
  responses    Response[]

  @@map("posts")
  @@index([expiresAt])
}

model Response {
  id           String      @id @default(uuid()) @db.Uuid
  postId       String      @db.Uuid @map("post_id")
  post         Post        @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  userId       String      @db.Uuid @map("user_id")
  user         User        @relation(fields: [userId], references: [id])
  
  contentType  ContentType @map("content_type")
  textContent  String?     @map("text_content") @db.Text
  voiceUrl     String?     @map("voice_url") @db.Text
  
  isHidden     Boolean     @default(false) @map("is_hidden")
  createdAt    DateTime    @default(now()) @map("created_at")

  @@map("responses")
}

model Category {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @unique
  icon      String?
  posts     Post[]
  createdAt DateTime @default(now()) @map("created_at")

  @@map("categories")
}

model Subscription {
  id                String   @id @default(uuid()) @db.Uuid
  name              String   
  postExpiryHours   Int      @map("post_expiry_hours")
  themeColor        String?  @map("theme_color")
  canHideResponse   Boolean  @default(false) @map("can_hide_response")
  price             Decimal  @db.Decimal(10, 2)
  
  users             User[]
  purchases         Purchase[]
  createdAt         DateTime @default(now()) @map("created_at")

  @@map("subscriptions")
}

model Purchase {
  id             String       @id @default(uuid()) @db.Uuid
  userId         String       @db.Uuid @map("user_id")
  user           User         @relation(fields: [userId], references: [id])
  
  subscriptionId String       @db.Uuid @map("subscription_id")
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])
  
  platform       String       // "ios" | "android" - needed for receipt validation
  transactionId  String       @map("transaction_id")
  purchaseDate   DateTime     @map("purchase_date")
  expiryDate     DateTime?    @map("expiry_date")
  status         String       

  @@map("purchases")
}

model PushToken {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @db.Uuid @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  deviceToken String   @map("device_token")
  platform    String?
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("push_tokens")
}